<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="大数据技术整理文档"><title>使用Phoenix将SQL代码移植至HBase | 博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用Phoenix将SQL代码移植至HBase</h1><a id="logo" href="/.">博客</a><p class="description">IT技术博客</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用Phoenix将SQL代码移植至HBase</h1><div class="post-meta">Jan 19, 2017<span> | </span><span class="category"><a href="/categories/HBase二次索引/">HBase二次索引</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase及云计算环境的安装配置"><span class="toc-number">2.</span> <span class="toc-text">HBase及云计算环境的安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境配置"><span class="toc-number">2.1.</span> <span class="toc-text">环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HBase-Shell使用"><span class="toc-number">2.2.</span> <span class="toc-text">HBase Shell使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HBase-Java-API-编程"><span class="toc-number">3.</span> <span class="toc-text">HBase Java API 编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于远程连接HBase"><span class="toc-number">3.1.</span> <span class="toc-text">关于远程连接HBase</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#源代码"><span class="toc-number">3.2.</span> <span class="toc-text">源代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phoenix的安装配置与使用"><span class="toc-number">4.</span> <span class="toc-text">Phoenix的安装配置与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Phoenix安装"><span class="toc-number">4.1.</span> <span class="toc-text">Phoenix安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phoenix配置"><span class="toc-number">4.2.</span> <span class="toc-text">phoenix配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phoenix语法简介"><span class="toc-number">4.3.</span> <span class="toc-text">phoenix语法简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建表"><span class="toc-number">4.3.1.</span> <span class="toc-text">创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除表"><span class="toc-number">4.3.2.</span> <span class="toc-text">删除表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#插入数据"><span class="toc-number">4.3.3.</span> <span class="toc-text">插入数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除数据"><span class="toc-number">4.3.4.</span> <span class="toc-text">删除数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查询数据"><span class="toc-number">4.3.5.</span> <span class="toc-text">查询数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改数据"><span class="toc-number">4.3.6.</span> <span class="toc-text">修改数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建序列"><span class="toc-number">4.3.7.</span> <span class="toc-text">创建序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用序列"><span class="toc-number">4.3.8.</span> <span class="toc-text">使用序列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除序列"><span class="toc-number">4.3.9.</span> <span class="toc-text">删除序列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装SQuirrel"><span class="toc-number">5.</span> <span class="toc-text">安装SQuirrel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装步骤"><span class="toc-number">5.1.</span> <span class="toc-text">安装步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一步："><span class="toc-number">5.1.1.</span> <span class="toc-text">第一步：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二步："><span class="toc-number">5.1.2.</span> <span class="toc-text">第二步：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三步：执行如下安装"><span class="toc-number">5.1.3.</span> <span class="toc-text">第三步：执行如下安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用"><span class="toc-number">5.2.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Phoenix移植SQL代码至HBase"><span class="toc-number">6.</span> <span class="toc-text">使用Phoenix移植SQL代码至HBase</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Phoenix-Java-Coding"><span class="toc-number">6.1.</span> <span class="toc-text">Phoenix Java Coding</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#每个表必须包含一个主键"><span class="toc-number">6.2.</span> <span class="toc-text">每个表必须包含一个主键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JDBC连接池"><span class="toc-number">6.3.</span> <span class="toc-text">JDBC连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#中文支持"><span class="toc-number">6.4.</span> <span class="toc-text">中文支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLOB和BLOB"><span class="toc-number">6.5.</span> <span class="toc-text">CLOB和BLOB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂的SQL语句"><span class="toc-number">6.6.</span> <span class="toc-text">复杂的SQL语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Phoenix性能调优"><span class="toc-number">7.</span> <span class="toc-text">Phoenix性能调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码移植流程"><span class="toc-number">7.1.</span> <span class="toc-text">代码移植流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oracle和HBase的性能差异"><span class="toc-number">7.2.</span> <span class="toc-text">Oracle和HBase的性能差异</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phoenix索引性能测试"><span class="toc-number">7.3.</span> <span class="toc-text">Phoenix索引性能测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Phoenix索引简介"><span class="toc-number">7.4.</span> <span class="toc-text">Phoenix索引简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#建立索引的方法与语句"><span class="toc-number">7.5.</span> <span class="toc-text">建立索引的方法与语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>HBase是云计算环境下最重要的NOSQL数据库，提供了基于Hadoop的数据存储、索引、查询，其最大的优点就是可以通过硬件的扩展从而几乎无限的扩展其存储和检索能力。但是HBase与传统的基于SQL语言的关系数据库无论从理念还是使用方式上都相去甚远，以至于要将基于SQL的项目移植到HBase时往往需要重写整个项目。<br>为了解决这个问题，很多开源项目提供了HBase的类SQL中间件，意即提供一种在HBase上使用的类SQL语言，使得程序员能够像使用关系数据库一样使用HBase，Apache Phoenix就是其中的一个优秀项目。<br>本文介绍了如何将基于传统关系数据库的程序通过Apache Phoenix移植到基于HBase的云计算平台上的方法，并详细讲述了该过程中碰到的种种困难。主要内容包括：</p>
<ul>
<li>HBase及云计算环境的安装配置；</li>
<li>HBase的Java API编程；</li>
<li>Phoenix的安装配置与使用；</li>
<li>Squirrel的安装配置与使用；</li>
<li>使用Phoenix移植SQL代码至HBase；</li>
<li>Phoenix性能调优；</li>
</ul>
<p>本文的读者应该是数据库系统项目的开发人员和维护人员，云计算项目开发人员，最好具有以下基本知识：</p>
<ul>
<li>Linux系统使用常识；</li>
<li>Hadoop、Hbase、Zookeeper等云计算环境使用常识；</li>
<li>Java编程开发基础；</li>
<li>SQL语言基础；</li>
<li>Oracle、SQLServer或Mysql等关系数据库使用管理基础；</li>
</ul>
<h2 id="HBase及云计算环境的安装配置"><a href="#HBase及云计算环境的安装配置" class="headerlink" title="HBase及云计算环境的安装配置"></a>HBase及云计算环境的安装配置</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>云计算环境通常安装在linux或者CentOS等类UNIX操作系统中，本文涉及的软件至少需要三个，即Hadoop、Hbase和Zookeeper，其版本号如下：</p>
<ul>
<li>hadoop-2.3.0-cdh5.1.0</li>
<li>zookeeper-3.4.5-cdh5.1.0</li>
<li>hbase-0.98.1-cdh5.1.0</li>
</ul>
<p>注意：本文使用了云时代的版本5.1.0，由于此类软件版本众多，互相之间的兼容性复杂，因此最好统一采用cdh的版本。系统配置如下图所示：</p>
<p><img src="http://static.zybuluo.com/yangzsh/5ey9onnziqp79vbwqtmm7s3b/4fccaccf0280d5b2db16f6a9ca341056_c.jpg" alt=""></p>
<p>系统一共六个节点，即Node1~Node6，hadoop安装在全部六个节点上，其中Node1和Node2是NameNode，其他是DataNode；ZooKeeper安装在Node4、Node5和Node6上，其端口使用默认的2181；Hbase安装在Node1、Node3~Node6上，其中Node1是HMaster，其他是HRegionServer。具体参数配置可以参考其他文档，此处不做详细描述。</p>
<p>注意：客户端必须通过ZooKeeper找到Hbase的入口。对于客户来说，只需要知道ZooKeeper在哪儿；需要访问hbase时，客户端去找ZooKeeper，ZooKeeper再去查询HBase的HMaster和HRegionServer等信息，具体情况见《HBase实战》63页。</p>
<h3 id="HBase-Shell使用"><a href="#HBase-Shell使用" class="headerlink" title="HBase Shell使用"></a>HBase Shell使用</h3><p>环境配置成功后，即可使用HBase Shell对HBase数据库进行操作，类似于Oracle提供的sqlplus。登陆任意一个安装了HBase的服务器，输入：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hbase <span class="keyword">shell</span></div><div class="line"><span class="keyword">list</span></div></pre></td></tr></table></figure></p>
<p>即可列出该hbase中存储的所有表格。<br>创建一个名为test的表格，它带有一个名为cf的列族，并使用list来查看表格是否被创建，然后插入一些数据：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">003</span>:<span class="number">0</span>&gt; create <span class="string">'test'</span>, <span class="string">'cf'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">1.2200</span> seconds</div><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">003</span>:<span class="number">0</span>&gt; list</div><div class="line">test</div><div class="line"><span class="number">1</span> row(s) <span class="keyword">in</span> <span class="number">0.0550</span> seconds</div><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">004</span>:<span class="number">0</span>&gt; put <span class="string">'test'</span>, <span class="string">'row1'</span>, <span class="string">'cf:a'</span>, <span class="string">'value1'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">0.0560</span> seconds</div><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">005</span>:<span class="number">0</span>&gt; put <span class="string">'test'</span>, <span class="string">'row2'</span>, <span class="string">'cf:b'</span>, <span class="string">'value2'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">0.0370</span> seconds</div><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">006</span>:<span class="number">0</span>&gt; put <span class="string">'test'</span>, <span class="string">'row3'</span>, <span class="string">'cf:c'</span>, <span class="string">'value3'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">0.0450</span> seconds</div></pre></td></tr></table></figure></p>
<p>使用scan来查看test表格中的内容：<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">hbase(main)<span class="symbol">:007</span><span class="symbol">:0</span>&gt; scan 'test'</div><div class="line"><span class="built_in">ROW</span>        <span class="built_in">COLUMN</span>+<span class="built_in">CELL</span></div><div class="line">row1       <span class="built_in">column</span>=<span class="symbol">cf:a</span>, timestamp=<span class="number">1288380727188</span>, <span class="built_in">value</span>=value1</div><div class="line">row2       <span class="built_in">column</span>=<span class="symbol">cf:b</span>, timestamp=<span class="number">1288380738440</span>, <span class="built_in">value</span>=value2</div><div class="line">row3       <span class="built_in">column</span>=<span class="symbol">cf:c</span>, timestamp=<span class="number">1288380747365</span>, <span class="built_in">value</span>=value3</div><div class="line"><span class="number">3</span> <span class="built_in">row</span>(s) in <span class="number">0.0590</span> seconds</div></pre></td></tr></table></figure></p>
<p>得到表中的一行数据：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">008</span>:<span class="number">0</span>&gt; get <span class="string">'test'</span>, <span class="string">'row1'</span></div><div class="line">COLUMN      CELL</div><div class="line">cf:<span class="selector-tag">a</span>        timestamp=<span class="number">1288380727188</span>, value=value1</div><div class="line"><span class="number">1</span> row(s) <span class="keyword">in</span> <span class="number">0.0400</span> seconds</div></pre></td></tr></table></figure></p>
<p>disable和drop一个表格：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">012</span>:<span class="number">0</span>&gt; disable <span class="string">'test'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">1.0930</span> seconds</div><div class="line"><span class="function"><span class="title">hbase</span><span class="params">(main)</span></span>:<span class="number">013</span>:<span class="number">0</span>&gt; drop <span class="string">'test'</span></div><div class="line"><span class="number">0</span> row(s) <span class="keyword">in</span> <span class="number">0.0770</span> seconds</div></pre></td></tr></table></figure></p>
<p>退出shell：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hbase(main):<span class="number">014</span>:<span class="number">0</span>&gt; <span class="keyword">exit</span></div></pre></td></tr></table></figure></p>
<p>其他更多具体的命令请参看HBase的手册或者在线帮助。</p>
<h2 id="HBase-Java-API-编程"><a href="#HBase-Java-API-编程" class="headerlink" title="HBase Java API 编程"></a>HBase Java API 编程</h2><p>使用HBase的Java API进行开发需要掌握HBase的基本理念，推荐阅读《HBase实战》一书。在进行开发的操作系统（例如Windows、Linux或者CentOS）中解压hbase-0.98.1-cdh5.1.0.tar.gz，得到开发所依赖的所有jar包，位于hbase-0.98.1-cdh5.1.0/lib目录中。<br>在开发环境（例如Eclipse、NetBean或者Intellij）中建立工程，导入hbase-0.98.1-cdh5.1.0\lib中的所有jar包。</p>
<h3 id="关于远程连接HBase"><a href="#关于远程连接HBase" class="headerlink" title="关于远程连接HBase"></a>关于远程连接HBase</h3><p>在给出源代码之前，先介绍一下远程连接HBase的问题。从Oracle时代过来的程序员，显然期望得到数据库服务器的ip、port和Service Name之类的信息。但是在连接HBase时，你需要的却是一个或多个ZooKeeper服务器的ip（或者hostname）和port，因为只有它才知晓整个HBase集群的元数据。显然，使用hostname比使用ip要显得习惯更好，因为它带来了更大的可移植性，因此费一点笔墨讲讲linux和windows的hostname设置。</p>
<p>在linux下，hostname通过修改/etc/hosts文件来完成，在集群的每台服务器上加入如下内容：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.101</span>  <span class="selector-tag">Node1</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.102</span>  <span class="selector-tag">Node2</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.103</span>  <span class="selector-tag">Node3</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.104</span>  <span class="selector-tag">Node4</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.105</span>  <span class="selector-tag">Node5</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.106</span>  <span class="selector-tag">Node6</span></div></pre></td></tr></table></figure></p>
<p>在各自的/etc/sysconfig/network文件中，将“HOSTNAME=”修改为“HOSTNAME=Node?”（将Node?替换为本服务器的hostname）。<br>在Windows下（仅测试过Win7 64），修改Windows/System32/drivers/etc/hosts文件，加入：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.101</span>  <span class="selector-tag">Node1</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.102</span>  <span class="selector-tag">Node2</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.103</span>  <span class="selector-tag">Node3</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.104</span>  <span class="selector-tag">Node4</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.105</span>  <span class="selector-tag">Node5</span></div><div class="line">192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.106</span>  <span class="selector-tag">Node6</span></div></pre></td></tr></table></figure></p>
<p>（不同的windows平台hosts文件的位置可能不一样，建议装一个everything，桌面搜索速度极快）。<br>其实多种方法都可以连接到ZooKeeper，例如ip加端口：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_ip = <span class="string">"192.168.1.104,</span></div><div class="line">192.168.1.105, 192.168.1.106"<span class="comment">;</span></div><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_port =</div><div class="line"><span class="string">"2181"</span><span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>或者hostname加端口：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_hostname = <span class="string">"Node4,Node5,Node6"</span>;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_port =</div><div class="line"><span class="string">"2181"</span>;</div></pre></td></tr></table></figure></p>
<p>或者将端口直接写在ip后：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_ip = <span class="string">"192.168.1.104:2181,</span></div><div class="line">192.168.1.105:2181, 192.168.1.106:2181"<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>或者将端口直接写在hostname后：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_hostname = <span class="string">"Node4:2181,Node5:2181,Node6:2181"</span>;</div></pre></td></tr></table></figure></p>
<p>或者仅使用一个ZooKeeper服务器：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_hostname = <span class="string">"Node4:2181"</span>;</div></pre></td></tr></table></figure></p>
<p>具体使用哪种方法就看程序员自己的偏好，也存在某种方法在某些版本中可能无法连接的问题，本文中没有穷尽测试，但个人认为hostname加端口的方法可能比较稳妥。</p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>本篇给出了使用Java API操作HBase的源代码，注意要将这几行替换为实际的ZooKeeper服务器地址、hostname和端口号：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_ip = <span class="string">"192.168.1.104,</span></div><div class="line">192.168.1.105, 192.168.1.106"<span class="comment">;</span></div><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_port =</div><div class="line"><span class="string">"2181"</span><span class="comment">;</span></div><div class="line">public <span class="keyword">static</span> <span class="built_in">String</span> hbase_svr_hostname = <span class="string">"Node4,Node5,Node6"</span><span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>代码功能包括：</p>
<ul>
<li>远程连接Hbase数据库；</li>
<li>创建表；</li>
<li>扫描所有表；</li>
<li>插入数据；</li>
<li>扫描数据；</li>
<li>删除数据；</li>
<li>删除表。</li>
</ul>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.wxb;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.Cell;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.CellUtil;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HBaseConfiguration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HColumnDescriptor;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.HTableDescriptor;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Delete;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Get;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.HBaseAdmin;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.HConnection;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.HConnectionManager;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.HTableInterface;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Put;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Result;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.ResultScanner;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.Scan;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * @author wxb hbase的基本操作方法</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> class HBaseSample &#123;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_ip = <span class="string">"192.168.1.104, 192.168.1.105, 192.168.1.106"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_port = <span class="string">"2181"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_hostname = <span class="string">"Node4,Node5,Node6"</span>;</div><div class="line">    <span class="keyword">private</span> HConnection connection = <span class="keyword">null</span>;</div><div class="line">    Configuration config = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 构造函数，构造一个HBaseSample对象，必须在最后调用close方法来关闭所有的连接，释放所有的资源</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> HBaseSample() &#123;</div><div class="line">        config = HBaseConfiguration.create();</div><div class="line">        config.<span class="built_in">set</span>(<span class="string">"hbase.zookeeper.quorum"</span>, hbase_svr_hostname);</div><div class="line">        config.<span class="built_in">set</span>(<span class="string">"hbase.zookeeper.property.clientPort"</span>, hbase_svr_port);</div><div class="line">        <span class="comment">// System.out.println(config.get("hbase.zookeeper.quorum"));</span></div><div class="line">        <span class="comment">// System.out.println(config.get("hbase.zookeeper.property.clientPort"));</span></div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            connection = HConnectionManager.createConnection(config);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 释放资源</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> close() &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</div><div class="line">                connection.close();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 创建表格</div><div class="line">     * </div><div class="line">     * @param tableName</div><div class="line">     * @param columnFarily</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> createTable(<span class="keyword">final</span> <span class="keyword">String</span> tableName, <span class="keyword">String</span> columnFarily) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != config) &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"begin create table..."</span>);</div><div class="line">            HBaseAdmin admin = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                admin = <span class="keyword">new</span> HBaseAdmin(config);</div><div class="line">                <span class="keyword">if</span> (admin.tableExists(tableName)) &#123;</div><div class="line">                    System.out.<span class="built_in">println</span>(tableName + <span class="string">" is already exist!"</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    HTableDescriptor tableDesc = <span class="keyword">new</span> HTableDescriptor(tableName);</div><div class="line">                    tableDesc.addFamily(<span class="keyword">new</span> HColumnDescriptor(columnFarily));</div><div class="line">                    admin.createTable(tableDesc);</div><div class="line">                    System.out.<span class="built_in">println</span>(tableDesc.toString()</div><div class="line">                            + <span class="string">" has been created."</span>);</div><div class="line">                &#125;</div><div class="line">                admin.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 向指定表格中添加一行数据</div><div class="line">     * </div><div class="line">     * @param table</div><div class="line">     * @param key</div><div class="line">     * @param family</div><div class="line">     * @param col</div><div class="line">     * @param dataIn</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> addOneRecord(<span class="keyword">String</span> table, <span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">String</span> family,</div><div class="line">            <span class="keyword">String</span> col, <span class="built_in">byte</span>[] dataIn) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HTableInterface tb = connection.getTable(table);</div><div class="line">                Put put = <span class="keyword">new</span> Put(<span class="built_in">key</span>.getBytes());</div><div class="line">                put.<span class="built_in">add</span>(family.getBytes(), col.getBytes(), dataIn);</div><div class="line">                tb.put(put);</div><div class="line">                System.out.<span class="built_in">println</span>(<span class="string">"put data key = "</span> + <span class="built_in">key</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                System.out.<span class="built_in">println</span>(<span class="string">"put data failed."</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 得到hbase中所有的表</div><div class="line">     * </div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> List&lt;<span class="keyword">String</span>&gt; getAllTables() &#123;</div><div class="line">        List&lt;<span class="keyword">String</span>&gt; tables = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HTableDescriptor[] allTable = connection.listTables();</div><div class="line">                <span class="keyword">if</span> (allTable.length &gt; <span class="number">0</span>)</div><div class="line">                    tables = <span class="keyword">new</span> ArrayList&lt;<span class="keyword">String</span>&gt;();</div><div class="line">                <span class="keyword">for</span> (HTableDescriptor hTableDescriptor : allTable) &#123;</div><div class="line">                    tables.<span class="built_in">add</span>(hTableDescriptor.getNameAsString());</div><div class="line">                    System.out.<span class="built_in">println</span>(hTableDescriptor.getNameAsString());</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> tables;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="built_in">byte</span>[] getValueWithKey(<span class="keyword">String</span> tableName, <span class="keyword">String</span> rowKey,</div><div class="line">            <span class="keyword">String</span> family, <span class="keyword">String</span> qualifier) &#123;</div><div class="line">        <span class="built_in">byte</span>[] rel = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HTableInterface table = connection.getTable(tableName);</div><div class="line">                Get <span class="built_in">get</span> = <span class="keyword">new</span> Get(rowKey.getBytes());</div><div class="line">                <span class="built_in">get</span>.addColumn(Bytes.toBytes(family), Bytes.toBytes(qualifier));</div><div class="line">                Result result = table.<span class="built_in">get</span>(<span class="built_in">get</span>);</div><div class="line">                <span class="keyword">if</span> (!result.isEmpty()) &#123;</div><div class="line">                    rel = result.getValue(Bytes.toBytes(family),</div><div class="line">                            Bytes.toBytes(qualifier));</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> rel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 从表中删除一行</div><div class="line">     * </div><div class="line">     * @param tableName</div><div class="line">     * @param rowKey</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> deleteWithKey(<span class="keyword">String</span> tableName, <span class="keyword">String</span> rowKey) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HTableInterface table = connection.getTable(tableName);</div><div class="line">                Delete delete = <span class="keyword">new</span> Delete(rowKey.getBytes());</div><div class="line">                table.delete(delete);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 得到一个表中的所有元素</div><div class="line">     * </div><div class="line">     * @param tableName</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> getAllData(<span class="keyword">String</span> tableName) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                HTableInterface table = connection.getTable(tableName);</div><div class="line">                Scan scan = <span class="keyword">new</span> Scan();</div><div class="line">                ResultScanner rs = table.getScanner(scan);</div><div class="line">                <span class="keyword">for</span> (Result r : rs) &#123;</div><div class="line">                    Cell[] cells = r.rawCells();</div><div class="line">                    System.out.<span class="built_in">println</span>(<span class="string">"This row have "</span> + cells.length</div><div class="line">                            + <span class="string">" cells:"</span>);</div><div class="line">                    <span class="keyword">for</span> (Cell cell : cells) &#123;</div><div class="line">                        <span class="keyword">String</span> row = Bytes.toString(CellUtil.cloneRow(cell));</div><div class="line">                        <span class="keyword">String</span> family = Bytes.toString(CellUtil</div><div class="line">                                .cloneFamily(cell));</div><div class="line">                        <span class="keyword">String</span> qualifier = Bytes.toString(CellUtil</div><div class="line">                                .cloneQualifier(cell));</div><div class="line">                        <span class="keyword">String</span> value = Bytes</div><div class="line">                                .toString(CellUtil.cloneValue(cell));</div><div class="line">                        System.out.<span class="built_in">println</span>(<span class="keyword">String</span>.format(<span class="string">"%s:%s:%s:%s"</span>, row,</div><div class="line">                                family, qualifier, value));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> deleteTable(<span class="keyword">String</span> tableName) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != config) &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"begin delete table..."</span>);</div><div class="line">            HBaseAdmin admin = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                admin = <span class="keyword">new</span> HBaseAdmin(config);</div><div class="line">                <span class="keyword">if</span> (!admin.tableExists(tableName)) &#123;</div><div class="line">                    System.out.<span class="built_in">println</span>(tableName + <span class="string">" is not exist!"</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    admin.disableTable(tableName);</div><div class="line">                    admin.deleteTable(tableName);</div><div class="line">                    System.out.<span class="built_in">println</span>(tableName + <span class="string">" has been deleted."</span>);</div><div class="line">                &#125;</div><div class="line">                admin.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"hbase could not connected!"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * @param args</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</div><div class="line">        HBaseSample sample = <span class="keyword">new</span> HBaseSample();</div><div class="line">        <span class="comment">// 1.create table and insert data</span></div><div class="line">        sample.createTable(<span class="string">"student"</span>, <span class="string">"fam1"</span>);</div><div class="line">        sample.addOneRecord(<span class="string">"student"</span>, <span class="string">"id1"</span>, <span class="string">"fam1"</span>, <span class="string">"name"</span>, <span class="string">"Jack"</span>.getBytes());</div><div class="line">        sample.addOneRecord(<span class="string">"student"</span>, <span class="string">"id1"</span>, <span class="string">"fam1"</span>, <span class="string">"address"</span>,</div><div class="line">                <span class="string">"HZ"</span>.getBytes());</div><div class="line"></div><div class="line">        <span class="comment">// 2.list table</span></div><div class="line">        sample.getAllTables();</div><div class="line"></div><div class="line">        <span class="comment">// 3.getValue</span></div><div class="line">        <span class="built_in">byte</span>[] value = sample.getValueWithKey(<span class="string">"student"</span>, <span class="string">"id1"</span>, <span class="string">"fam1"</span>,</div><div class="line">                <span class="string">"address"</span>);</div><div class="line">        System.out.<span class="built_in">println</span>(<span class="string">"value = "</span> + Bytes.toString(value));</div><div class="line"></div><div class="line">        <span class="comment">// 4.addOneRecord and delete</span></div><div class="line"><span class="comment">//      sample.addOneRecord("student", "id2", "fam1", "name", "wxb".getBytes());</span></div><div class="line"><span class="comment">//      sample.addOneRecord("student", "id2", "fam1", "address",</span></div><div class="line"><span class="comment">//              "here".getBytes());</span></div><div class="line"><span class="comment">//      sample.deleteWithKey("student", "id2");</span></div><div class="line"></div><div class="line">        <span class="comment">// 5.scan table</span></div><div class="line">        sample.getAllData(<span class="string">"student"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 6.delete table</span></div><div class="line">        <span class="comment">// sample.deleteTable("student");</span></div><div class="line"></div><div class="line">        sample.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Phoenix的安装配置与使用"><a href="#Phoenix的安装配置与使用" class="headerlink" title="Phoenix的安装配置与使用"></a>Phoenix的安装配置与使用</h2><p>从上一章可以看出，HBase的基本理念和传统的关系数据库是截然不同的，为了使得熟悉SQL的程序员能够快速使用HBase，使用Apache Phoenix是比较好的办法。它提供了一组类似于SQL的语法，以及序列、索引、函数等工具，使得将SQL代码移植至HBase成为可能。</p>
<h3 id="Phoenix安装"><a href="#Phoenix安装" class="headerlink" title="Phoenix安装"></a>Phoenix安装</h3><p>同其他分布式软件一样，Phoenix的安装也是较为复杂的，且要密切关注其版本兼容性，否则很可能无法正常运行。例如Phoenix4.x版本都有兼容HBase0.98的版本，但是经过两天的测试才发现不同的Phoenix版本对HBase0.98的小版本号的要求不同。<br>由于本文使用的是HBase0.98.1，因此只能使用Phoenix4.1.0版本。如果使用的Phoenix版本和HBase版本不兼容，会出现第一次能够连接HBase，但以后都连接失败的现象。<br>Phoenix的具体安装步骤如下：<br>第一步：将phoenix-4.1.0-bin.tar.gz拷贝到Node1（HBase的HMaster）的某路径下，解压缩，拷贝hadoop2/phoenix-4.1.0-server-hadoop2.jar到HBase的lib目录下。<br>第二步：然后用scp（关于scp和ssh的设置请参考网上的其他文章，假设用户名为hadoop）拷贝到各个regionserver的HBase的lib目录下：<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">scp phoenix-<span class="number">4.1</span>.<span class="number">0</span>-server-hadoop2.jar hadoop@<span class="symbol">Node3:</span>/home/hadoop/hbase-<span class="number">0.98</span>.<span class="number">1</span>-cdh5.<span class="number">1.0</span>/<span class="class"><span class="keyword">lib</span>/</span></div><div class="line">phoenix-core-<span class="number">4.6</span>.<span class="number">0</span>-HBase-<span class="number">0.98</span>.jar                                                                                                    </div><div class="line">scp phoenix-<span class="number">4.1</span>.<span class="number">0</span>-server-hadoop2.jar hadoop@<span class="symbol">Node4:</span>/home/hadoop/hbase-<span class="number">0.98</span>.<span class="number">1</span>-cdh5.<span class="number">1.0</span>/<span class="class"><span class="keyword">lib</span>/</span></div><div class="line">phoenix-core-<span class="number">4.6</span>.<span class="number">0</span>-HBase-<span class="number">0.98</span>.jar                                                                                                  </div><div class="line">scp phoenix-<span class="number">4.1</span>.<span class="number">0</span>-server-hadoop2.jar hadoop@<span class="symbol">Node5:</span>/home/hadoop/hbase-<span class="number">0.98</span>.<span class="number">1</span>-cdh5.<span class="number">1.0</span>/<span class="class"><span class="keyword">lib</span>/</span></div><div class="line">phoenix-core-<span class="number">4.6</span>.<span class="number">0</span>-HBase-<span class="number">0.98</span>.jar</div><div class="line">scp phoenix-<span class="number">4.1</span>.<span class="number">0</span>-server-hadoop2.jar hadoop@<span class="symbol">Node6:</span>/home/hadoop/hbase-<span class="number">0.98</span>.<span class="number">1</span>-cdh5.<span class="number">1.0</span>/<span class="class"><span class="keyword">lib</span>/</span></div><div class="line">phoenix-core-<span class="number">4.6</span>.<span class="number">0</span>-HBase-<span class="number">0.98</span>.jar</div></pre></td></tr></table></figure></p>
<p>第三步：在HMaster上重启hbase（即Node1）；<br>第四步：将phoenix-4.1.0-client-hadoop2.jar加入客户端的CLASSPATH变量路径中，修改用户的.bash_profile文件，同时将此文件拷贝到hbase的lib目录下。<br>第五步：测试使用phoenix，输入命令：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sqlline<span class="selector-class">.py</span> Node4:<span class="number">2181</span></div><div class="line"></div><div class="line"><span class="comment">// 假如大数据平台是HDP，里面Phoenix可以选择自动安装，但是启动命令不同，如下：</span></div><div class="line">$ ./sqlline<span class="selector-class">.py</span> localhost:<span class="number">2181</span>/hbase-unsecure</div></pre></td></tr></table></figure></p>
<p>注意：后面的参数是ZooKeeper的服务器和端口。<br>出现以下显示则说明连接成功。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[hadoop<span class="meta">@iips</span>25 hadoop2]$bin/sqlline.py <span class="string">Node1:</span><span class="number">2181</span></div><div class="line">Setting <span class="string">property:</span> [isolation, TRANSACTION_READ_COMMITTED]</div><div class="line"><span class="string">issuing:</span> !connect <span class="string">jdbc:</span><span class="string">phoenix:</span>Node4 none none org.apache.phoenix.jdbc.PhoenixDriver</div><div class="line">Connecting to <span class="string">jdbc:</span><span class="string">phoenix:</span>Node4</div><div class="line"><span class="number">16</span><span class="regexp">/06/</span><span class="number">21</span> <span class="number">08</span>:<span class="number">04</span>:<span class="number">24</span> WARN impl.<span class="string">MetricsConfig:</span> Cannot locate <span class="string">configuration:</span> tried hadoop-metrics2-phoenix.properties,hadoop-metrics2.properties</div><div class="line">Connected <span class="string">to:</span> Phoenix (version <span class="number">4.1</span>)</div><div class="line"><span class="string">Driver:</span> org.apache.phoenix.jdbc.PhoenixDriver (version <span class="number">4.1</span>)</div><div class="line">Autocommit <span class="string">status:</span> <span class="literal">true</span></div><div class="line">Transaction <span class="string">isolation:</span> TRANSACTION_READ_COMMITTED</div><div class="line">Building list of tables and columns <span class="keyword">for</span> tab-completion (set fastconnect to <span class="literal">true</span> to skip)...</div><div class="line"><span class="number">59</span>/<span class="number">59</span> (<span class="number">100</span>%) Done</div><div class="line">Done</div><div class="line">sqlline version <span class="number">1.1</span><span class="number">.2</span></div><div class="line"><span class="number">0</span>: <span class="string">jdbc:</span><span class="string">phoenix:</span>Node4&gt;</div></pre></td></tr></table></figure></p>
<p>查看数据库表：（注意，phoenix只能看到自己创建的表，不能看到HBase创建的表）<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">0: jdbc:phoenix:Node4&gt; !tables</div><div class="line">+------------+-------------+------------+------------+------------+------------+---------------------------+----------------+-------------+----------------+--------+</div><div class="line">|<span class="string"> TABLE_CAT  </span>|<span class="string"> TABLE_SCHEM </span>|<span class="string"> TABLE_NAME </span>|<span class="string"> TABLE_TYPE </span>|<span class="string">  REMARKS   </span>|<span class="string"> TYPE_NAME  </span>|<span class="string"> SELF_REFERENCING_COL_NAME </span>|<span class="string"> REF_GENERATION </span>|<span class="string"> INDEX_STATE </span>|<span class="string"> IMMUTABLE_ROWS </span>|<span class="string"> SALT_B </span>|</div><div class="line">+------------+-------------+------------+------------+------------+------------+---------------------------+----------------+-------------+----------------+--------+</div><div class="line">|<span class="string"> null       </span>|<span class="string"> SYSTEM      </span>|<span class="string"> CATALOG    </span>|<span class="string"> SYSTEM TABLE </span>|<span class="string"> null       </span>|<span class="string"> null       </span>|<span class="string"> null                      </span>|<span class="string"> null           </span>|<span class="string"> null        </span>|<span class="string"> false          </span>|<span class="string"> null </span>|</div><div class="line">|<span class="string"> null       </span>|<span class="string"> SYSTEM      </span>|<span class="string"> SEQUENCE   </span>|<span class="string"> SYSTEM TABLE </span>|<span class="string"> null       </span>|<span class="string"> null       </span>|<span class="string"> null                      </span>|<span class="string"> null           </span>|<span class="string"> null        </span>|<span class="string"> false          </span>|<span class="string"> null </span>|</div><div class="line">+------------+-------------+------------+------------+------------+------------+---------------------------+----------------+-------------+----------------+--------+</div><div class="line">0: jdbc:phoenix:Node4&gt;</div></pre></td></tr></table></figure></p>
<p>创建表，并插入数据：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">0: jdbc:phoenix:Node4&gt; create table abc(a integer primary key, b integer) ;</div><div class="line">No rows affected (1.133 seconds)</div><div class="line">0: jdbc:phoenix:Node4&gt; UPSERT INTO abc VALUES (1, 1); </div><div class="line">1 row affected (0.064 seconds)</div><div class="line">0: jdbc:phoenix:Node4&gt; UPSERT INTO abc VALUES (2, 2); </div><div class="line">1 row affected (0.009 seconds)</div><div class="line">0: jdbc:phoenix:Node4&gt; UPSERT INTO abc VALUES (3, 12); </div><div class="line">1 row affected (0.009 seconds)</div><div class="line"><span class="section">0: jdbc:phoenix:Node4&gt; select * from abc;</span></div><div class="line">+------------+------------+</div><div class="line"><span class="section">|     A      |     B      |</span></div><div class="line">+------------+------------+</div><div class="line">| 1          | 1          |</div><div class="line">| 2          | 2          |</div><div class="line"><span class="section">| 3          | 12         |</span></div><div class="line">+------------+------------+</div><div class="line">3 rows selected (0.082 seconds)</div><div class="line">0: jdbc:phoenix:Node4&gt;</div></pre></td></tr></table></figure></p>
<p>创建包含中文的表（注意中文要使用VARCHAR）：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">create table user ( id integer primary key, name VARCHAR);</div><div class="line">upsert into user values ( 2, <span class="emphasis">'测试员2'</span>);</div><div class="line">upsert into user values ( 1, <span class="emphasis">'测试员1'</span>);</div><div class="line"><span class="section">select * from user;</span></div><div class="line">+------------+------------+</div><div class="line"><span class="section">|     ID     |    NAME    |</span></div><div class="line">+------------+------------+</div><div class="line">| 1          | 测试员1        |</div><div class="line">| 2          | 测试员2         |</div></pre></td></tr></table></figure></p>
<h3 id="phoenix配置"><a href="#phoenix配置" class="headerlink" title="phoenix配置"></a>phoenix配置</h3><p>在hbase集群每个服务器的hbase-site.xml配置文件中，加入：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;hbase<span class="selector-class">.regionserver</span><span class="selector-class">.wal</span><span class="selector-class">.codec</span>&lt;/name&gt;</div><div class="line">  &lt;value&gt;org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hbase</span><span class="selector-class">.regionserver</span><span class="selector-class">.wal</span><span class="selector-class">.IndexedWALEditCodec</span>&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>这是在phoenix中建立索引的先决条件。如果不添加此设置，Phoenix依然可以正常使用，但不能建立索引。</p>
<h3 id="phoenix语法简介"><a href="#phoenix语法简介" class="headerlink" title="phoenix语法简介"></a>phoenix语法简介</h3><p>phoenix的语法可参考其官方网站，也可下载其“Grammar _ Apache Phoenix.html”网页。<br>访问Phoenix时，可以使用其提供的sqlline.py命令，也可以使用下一章介绍的数据库图形界面工具Squirrel，当然也可以通过Phoenix提供的Java API。</p>
<h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><p>注意：Phoenix中的表必须有主键，这一点和许多关系数据库不同。因为主键是后续很多表操作的必备因素。<br>CREATE TABLE IF NOT EXISTS MYTABLE (ID INTEGER PRIMARY KEY, NAME VARCHAR, SEX VARCHAR, ADDRESS VARCHAR);</p>
<h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><p>DROP TABLE IF EXISTS MYTABLE;</p>
<h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><p>UPSERT INTO MYTABLE VALUES (1, ‘WXB’, ‘MALE’, ‘010-22222222’);<br>注意phoenix使用UPSERT而不是INSERT。</p>
<h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><p>DELETE FROM MYTABLE WHERE ID = 1;</p>
<h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><p>SELECT * FROM MYTABLE WHERE ID=1;</p>
<h4 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h4><p>UPSERT INTO MYTABLE VALUES (1, ‘WXB’, ‘MALE’, ‘010-22222222’);<br>可以看到，修改数据与插入数据一样，都是使用UPSERT语句，若此主键对应的行不存在，就插入，否则就修改。这也是为什么Phoenix的表必须有主键的原因之一。</p>
<h4 id="创建序列"><a href="#创建序列" class="headerlink" title="创建序列"></a>创建序列</h4><p>Phoenix的序列与Oracle很像，也是先创建，然后调用next得到下一个值。也可以继续调用current value得到当前序列值，没有调用next时，不能使用current value。<br>创建一个序列：<br>CREATE SEQUENCE IF NOT EXISTS WXB_SEQ START WITH 1000 INCREMENT BY 1 MINVALUE 1000 MAXVALUE 999999999 CYCLE CACHE 30;<br>其含义基本上与Oracle类似。</p>
<h4 id="使用序列"><a href="#使用序列" class="headerlink" title="使用序列"></a>使用序列</h4><p>序列只能在Select或者Upsert语句中使用，例如在Upsert中使用：<br>UPSERT INTO MYTABLE VALUES (NEXT VALUE FOR WXB_SEQ, ‘WXB’, ‘MALE’, ‘010-22222222’);<br>读取序列的当前值时，采用这个语句：<br>SELECT CURRENT VALUE FOR WXB_SEQ DUALID FROM WXB_DUAL;<br>然后读取DUALID就可得到序列的当前值。<br>这里的WXB_DUAL是我自己创建的一个特殊表，用来模拟Oracle中的Dual表。<br>CREATE TABLE  IF NOT EXISTS WXB_DUAL (DUALID INTEGER PRIMARY KEY );<br>UPSERT INTO WXB_DUAL VALUES (1);</p>
<h4 id="删除序列"><a href="#删除序列" class="headerlink" title="删除序列"></a>删除序列</h4><p>DROP SEQUENCE IF EXISTS WXB_SEQ;</p>
<p>本章至此为止，详细的操作留待后续再讲。</p>
<h2 id="安装SQuirrel"><a href="#安装SQuirrel" class="headerlink" title="安装SQuirrel"></a>安装SQuirrel</h2><p>Squirrel是一个图形化的数据库工具，它可以将Phoenix以图形化的方式展示出来，它可以安装在windows或linux系统中。</p>
<h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><h4 id="第一步："><a href="#第一步：" class="headerlink" title="第一步："></a>第一步：</h4><p>设置好JDK，JAVA_HOME，CLASSPATH等一系列的环境变量，注意无论是在windows还是在linux下，都需要上面安装的hbase和phoenix的存放jar包的目录，并将其设置到CLASSPATH中。windows下的CLASSPATH如下：<br>%JAVA_HOME%\lib;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;D:\hbase-0.98.1-cdh5.1.0\lib;D:\phoenix-4.1.0-bin\hadoop2<br>linux的CLASSPATH如下：<br>export PHOENIX_HOME=/home/hadoop/phoenix-4.1.0-bin<br>export CLASSPATH=$PHOENIX_HOME/hadoop2/phoenix-4.1.0-client-hadoop2.jar:$HBASE_HOME/lib/:$CLASSPATH<br>export PATH=$PHOENIX_HOME/bin:$PATH</p>
<h4 id="第二步："><a href="#第二步：" class="headerlink" title="第二步："></a>第二步：</h4><p>下载解压squirrel-sql-snapshot-20160613_2107-standard.jar（最新版本的squirrel安装包），在命令行中运行java -jar squirrel-sql-snapshot-20160613_2107-standard.jar开始安装。 </p>
<h4 id="第三步：执行如下安装"><a href="#第三步：执行如下安装" class="headerlink" title="第三步：执行如下安装"></a>第三步：执行如下安装</h4><ol>
<li><p>Remove prior phoenix-[oldversion]-client.jar from the lib directory of SQuirrel, copy phoenix-[newversion]-client.jar to the lib directory (newversion should be compatible with the version of the phoenix server jar used with your HBase installation) </p>
</li>
<li><p>Start SQuirrel and add new driver to SQuirrel (Drivers -&gt; New Driver) </p>
</li>
<li><p>In Add Driver dialog box, set Name to Phoenix, and set the Example URL to jdbc:phoenix:localhost. </p>
</li>
<li><p>Type “org.apache.phoenix.jdbc.PhoenixDriver” into the Class Name textbox and click OK to close this dialog. </p>
</li>
<li><p>Switch to Alias tab and create the new Alias (Aliases -&gt; New Aliases) </p>
</li>
<li><p>In the dialog box, Name:Any name, Driver: Phoenix, User Name:Anything, Password:Anything </p>
</li>
<li><p>Construct URL as follows: jdbc:phoenix:zookeeper quorum server. For example, to connect to a local HBase use: jdbc:phoenix:localhost </p>
</li>
<li><p>Press Test (which should succeed if everything is setup correctly) and press OK to close. </p>
</li>
<li><p>Now double click on your newly created Phoenix alias and click Connect. Now you are ready to run SQL queries against Phoenix. </p>
</li>
</ol>
<p>注意，我们连接的URL是jdbc:phoenix:Node4，用户名和密码随意即可。连接成功后，如下：</p>
<p><img src="http://static.zybuluo.com/yangzsh/ctvn8uqah2riyjm20sq1iagh/4fccaccf0280d5b2db16f6a9ca341056_b.jpg" alt=""></p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>安装完毕后，就可以在Squirrel中执行各种phoenix支持的类SQL语句和观察数据了，例如在SQL栏中输入如下语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> MYTABLE (<span class="keyword">ID</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span>, <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>, SEX <span class="built_in">VARCHAR</span>, ADDRESS <span class="built_in">VARCHAR</span>);</div><div class="line"></div><div class="line">UPSERT INTO MYTABLE VALUES (1, 'WXB', 'MALE', '010-22222222');</div><div class="line"></div><div class="line">UPSERT INTO MYTABLE VALUES (2, ‘LL’, 'MALE', '010-11111111');</div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> MYTABLE;</div></pre></td></tr></table></figure></p>
<p>结果如下：<br><img src="http://static.zybuluo.com/yangzsh/5ey9onnziqp79vbwqtmm7s3b/4fccaccf0280d5b2db16f6a9ca341056_c.jpg" alt=""></p>
<p>使用Squirrel的好处在于可以方便的查看数据库中的各种对象，以及编辑和执行复杂的phoenix类sql脚本。</p>
<h2 id="使用Phoenix移植SQL代码至HBase"><a href="#使用Phoenix移植SQL代码至HBase" class="headerlink" title="使用Phoenix移植SQL代码至HBase"></a>使用Phoenix移植SQL代码至HBase</h2><p>Phoenix提供了完全适配JDBC的API，程序员可以像操作关系数据库（例如Oracle）一样来使用JDBC来操作Phoenix，这也是Phoenix的最大的优势所在。唯一需要注意的是，提交的SQL语句必须符合Phoenix语法，虽然此语法很类似于SQL，但还是有许多不同之处。</p>
<h3 id="Phoenix-Java-Coding"><a href="#Phoenix-Java-Coding" class="headerlink" title="Phoenix Java Coding"></a>Phoenix Java Coding</h3><p>本章给出了一个最基本的Phoenix JDBC源代码实例，注意其中所引用的所有类几乎都来自于java.sql.*包，与Oracle唯一的不同是其driver的字符串，该字符串等于前面连接Squirrel的连接字符串，你可以在Squirrel上测试driver字符串是否能够正确连接。driver字符串一般为jdbc:phoenix:ZooKeeper_hostname:port，例如jdbc:phoenix:Node4,Node5,Node6:2181。但是在端口为默认2181端口时，也可以省略端口号。 </p>
<p>编码之前将phoenix-4.1.0-client-hadoop2.jar加入java项目的依赖Libraries，例子代码如下：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div></pre></td><td class="code"><pre><div class="line">package com.wxb;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.sql.Connection;</div><div class="line"><span class="keyword">import</span> java.sql.DriverManager;</div><div class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</div><div class="line"><span class="keyword">import</span> java.sql.ResultSet;</div><div class="line"><span class="keyword">import</span> java.sql.SQLException;</div><div class="line"><span class="keyword">import</span> java.sql.Statement;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * @author wxb  Phoenix的基本操作方法</div><div class="line"> * </div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> PhoenixSample &#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_ip = <span class="string">"192.168.1.104, 192.168.1.105, 192.168.1.106"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_port = <span class="string">"2181"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> hbase_svr_hostname = <span class="string">"Node4,Node5,Node6"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * 所有几种方式的driver都能够通过测试： 1.Node4 2.Node4,Node5,Node6 3.Node4:2181</div><div class="line">     * 4.Node4,Node5,Node6:2181 5.Node4:2181,Node5:2181,Node6:2181</div><div class="line">     * 6.101.60.27.114</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> driver = <span class="string">"jdbc:phoenix:"</span> + hbase_svr_hostname;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> createTable(<span class="keyword">String</span> tableName) &#123;</div><div class="line">        System.out.<span class="built_in">println</span>(<span class="string">"create table "</span> + tableName);</div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"create table  if not exists "</span> + tableName</div><div class="line">                    + <span class="string">" (mykey integer not null primary key, mycolumn varchar)"</span>);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> addRecord(<span class="keyword">String</span> tableName, <span class="keyword">String</span> values) &#123;</div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"upsert into "</span> + tableName + <span class="string">" values ("</span></div><div class="line">                    + values + <span class="string">")"</span>);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> deleteRecord(<span class="keyword">String</span> tableName, <span class="keyword">String</span> whereClause) &#123;</div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"delete from "</span> + tableName + <span class="string">" where "</span></div><div class="line">                    + whereClause);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> createSequence(<span class="keyword">String</span> seqName) &#123;</div><div class="line">        System.out.<span class="built_in">println</span>(<span class="string">"Create Sequence :"</span> + seqName);</div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"CREATE SEQUENCE IF NOT EXISTS "</span></div><div class="line">                    + seqName</div><div class="line">                    + <span class="string">" START WITH 1000 INCREMENT BY 1 MINVALUE 1000 MAXVALUE 999999999 CYCLE CACHE 30"</span>);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> dropSequence(<span class="keyword">String</span> seqName) &#123;</div><div class="line">        System.out.<span class="built_in">println</span>(<span class="string">"drop Sequence :"</span> + seqName);</div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"DROP SEQUENCE IF EXISTS "</span> + seqName);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> getAllData(<span class="keyword">String</span> tableName) &#123;</div><div class="line"></div><div class="line">        System.out.<span class="built_in">println</span>(<span class="string">"Get all data from :"</span> + tableName);</div><div class="line">        ResultSet rset = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            PreparedStatement statement = con.prepareStatement(<span class="string">"select * from "</span></div><div class="line">                    + tableName);</div><div class="line">            rset = statement.executeQuery();</div><div class="line">            <span class="built_in">while</span> (rset.next()) &#123;</div><div class="line">                System.out.<span class="built_in">print</span>(rset.getInt(<span class="string">"mykey"</span>));</div><div class="line">                System.out.<span class="built_in">println</span>(<span class="string">" "</span> + rset.getString(<span class="string">"mycolumn"</span>));</div><div class="line">            &#125;</div><div class="line">            statement.<span class="built_in">close</span>();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> dropTable(<span class="keyword">String</span> tableName) &#123;</div><div class="line"></div><div class="line">        Statement stmt = null;</div><div class="line"></div><div class="line">        <span class="built_in">try</span> &#123;</div><div class="line">            Connection con = DriverManager.getConnection(driver);</div><div class="line">            stmt = con.createStatement();</div><div class="line"></div><div class="line">            stmt.executeUpdate(<span class="string">"drop table  if  exists "</span> + tableName);</div><div class="line">            con.commit();</div><div class="line">            con.<span class="built_in">close</span>();</div><div class="line">            System.out.<span class="built_in">println</span>(<span class="string">"drop table "</span> + tableName);</div><div class="line">        &#125; <span class="built_in">catch</span> (SQLException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</div><div class="line">        createTable(<span class="string">"wxb_test"</span>);</div><div class="line">        createSequence(<span class="string">"WXB_SEQ_ID"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 使用了Sequence</span></div><div class="line">        addRecord(<span class="string">"wxb_test"</span>, <span class="string">"NEXT VALUE FOR WXB_SEQ_ID,'wxb'"</span>);</div><div class="line">        addRecord(<span class="string">"wxb_test"</span>, <span class="string">"NEXT VALUE FOR WXB_SEQ_ID,'wjw'"</span>);</div><div class="line">        addRecord(<span class="string">"wxb_test"</span>, <span class="string">"NEXT VALUE FOR WXB_SEQ_ID,'wjl'"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// deleteRecord("wxb_test", " mykey = 1 ");</span></div><div class="line">        getAllData(<span class="string">"wxb_test"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// dropTable("wxb_test");</span></div><div class="line"><span class="comment">//      dropSequence("WXB_SEQ_ID");</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="每个表必须包含一个主键"><a href="#每个表必须包含一个主键" class="headerlink" title="每个表必须包含一个主键"></a>每个表必须包含一个主键</h3><p>在使用Phoenix时，建立的每个表都必须包含一个主键，这与关系数据库不同。而且每个表的主键会自动被索引，这意味着在select语句的where子句中使用主键作为条件，会得到最快的查询速度。关于索引，在后续章节中再详细介绍。<br>我的建议是，为每个表创建一个序列，并在插入数据时以序列的值作为主键的值。</p>
<h3 id="JDBC连接池"><a href="#JDBC连接池" class="headerlink" title="JDBC连接池"></a>JDBC连接池</h3><p>Phoenix支持用户自己创建JDBC连接池，可以将基于JDBC连接池的代码复制过来，把Driver部分修改一番即可。</p>
<h3 id="中文支持"><a href="#中文支持" class="headerlink" title="中文支持"></a>中文支持</h3><p>涉及中文的字段可设置为VARCHAR类型，经测试没有问题。</p>
<h3 id="CLOB和BLOB"><a href="#CLOB和BLOB" class="headerlink" title="CLOB和BLOB"></a>CLOB和BLOB</h3><p>CLOB和BLOB字段我都设置为VARCHAR类型，经测试存储400k字节的数据没有问题，更多的没有测试。</p>
<h3 id="复杂的SQL语句"><a href="#复杂的SQL语句" class="headerlink" title="复杂的SQL语句"></a>复杂的SQL语句</h3><p>因为本文使用的Phoenix版本不是最新版，因此官网上给出的SQL语法不是完全都能够支持，例如下面的语句就不能支持：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span> <span class="keyword">from</span> wxb_senword <span class="keyword">where</span> swid <span class="keyword">in</span> (<span class="keyword">select</span> swid <span class="keyword">from</span> wxb_rela_sw_group <span class="keyword">where</span> groupid=<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>因此对于一些复杂的SQL语句，需要先到官网上查询语法，然后在phoenix中进行测试，测试通过后才能够在程序中使用。<br>两个表的关联查询是可行的，语句如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> d.swid,d.swname, d.userid, e.groupid <span class="keyword">FROM</span> wxb_senword d <span class="keyword">JOIN</span> wxb_rela_sw_group e <span class="keyword">ON</span> e.swid = d.swid <span class="keyword">where</span> e.groupid=<span class="number">1</span>;</div></pre></td></tr></table></figure></p>
<h2 id="Phoenix性能调优"><a href="#Phoenix性能调优" class="headerlink" title="Phoenix性能调优"></a>Phoenix性能调优</h2><h3 id="代码移植流程"><a href="#代码移植流程" class="headerlink" title="代码移植流程"></a>代码移植流程</h3><p>将基于SQL的java代码移植到Phoenix其实不难，以Oracle为例，基本流程如下：</p>
<ul>
<li><p>将Oracle中的所有表在Phoenix中重新建立一次，没有主键的自己加一个主键（并建立对应的序列）；</p>
</li>
<li><p>将Oracle中所有的序列、视图都在Phoenix中重新建立一次；</p>
</li>
<li><p>将程序中的每条SQL语句都翻译为Phoenix的SQL语句，并测试该语句是否能够正确运行，若不能，总能找到几条简单的语句进行替代。</p>
</li>
</ul>
<h3 id="Oracle和HBase的性能差异"><a href="#Oracle和HBase的性能差异" class="headerlink" title="Oracle和HBase的性能差异"></a>Oracle和HBase的性能差异</h3><p>移植完成后，经过一系列debug，程序总算能够正常运行了。但是性能问题会变得非常严重，这是关系数据库和HBase之间的设计思路和应用问题域之间的差异造成的。<br>Oracle的设计思路是尽可能的快速对数据进行操作，但是随着表中记录数的不断增加，查询性能持续下降。要对Oracle进行硬件扩充会比较困难，而且会在单表一亿条左右时（没有经过本人验证）碰到性能瓶颈。Oracle的优势是在表中记录数不多（几百万以内，具体看服务器性能）时拥有极高的查询速度。<br>而HBase的优势是让单表可以存储几乎无限的记录，并且可以方便的扩充硬件，使得查询速度可以达到一个稳定的标准。但是其缺点在于表中数据不多时，查询速度相对较慢。经测试，Phoenix的表在记录数很少时（数十条），查询单条数据也需要0.2秒左右（服务器集群配置见前面的章节），而同时单服务器的Oracle查询这样的数据仅需30ms左右，相差接近十倍。</p>
<h3 id="Phoenix索引性能测试"><a href="#Phoenix索引性能测试" class="headerlink" title="Phoenix索引性能测试"></a>Phoenix索引性能测试</h3><p>与Oracle相比，Phoenix在性能上还有一个特点就是在没有索引的情况下，查询性能下降很快。<br>例如下表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> WXB_WORD (<span class="keyword">ID</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span>, <span class="keyword">NAME</span> <span class="built_in">VARCHAR</span>, <span class="keyword">VALUE</span> <span class="keyword">DOUBLE</span>, HEAT <span class="built_in">INTEGER</span>, FOCUSLEVEL <span class="built_in">INTEGER</span>, USERID <span class="built_in">INTEGER</span>);</div></pre></td></tr></table></figure></p>
<p>不建立索引的情况下，在前面介绍的集群上进行查询性能测试，查询语句如下(确保单条命中)：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> WXB_WORD <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=’XXX’;</div></pre></td></tr></table></figure></p>
<p>50万条记录，平均单条查询时间为0.38秒；<br>100万条记录，平均单条查询时间为0.79秒；<br>500万条记录，平均单条查询时间为4.31秒；<br><strong>然而在NAME字段上建立索引后，将表中数据增加到1亿条，平均单条查询时间为0.164秒，可见索引对Phoenix性能的提升作用是无可替代的。</strong></p>
<h3 id="Phoenix索引简介"><a href="#Phoenix索引简介" class="headerlink" title="Phoenix索引简介"></a>Phoenix索引简介</h3><p>Phoenix中的索引被称之为Secondary Indexing（二级索引），这是为了和HBase主键上的索引区分开。在HBase中，每个表有且仅有一个主键的索引，该索引按照字典序进行排序；所有不基于主键的查询都会导致全表扫描，效率非常低下。在Phoenix中，可以对表中的任何一个字段或者几个字段建立二级索引，该索引实际上是一个独立的表，表中包含了被索引的列以及建立索引时包含的列（在索引的include语句中包含的列）。当用户对表进行查询时，会首先对索引进行查询，若能够得到全部的结果，则会直接返回，否则就到原表中进行查询。<br>注意，Phoenix的每个表都可以建立多个索引，索引和原表之间的同步由Phoenix保证。但是，索引越多，写入效率越低。<br>Phoenix支持两种类型的索引：可变索引（mutable indexing）和不可变索引（immutable indexing）。在表中数据需要变化时，使用可变索引；当应用场景为“一次写入，只会追加，永不改变”时使用不可变索引。本文中只使用了可变索引。</p>
<h3 id="建立索引的方法与语句"><a href="#建立索引的方法与语句" class="headerlink" title="建立索引的方法与语句"></a>建立索引的方法与语句</h3><p>在建立索引之前，再次检查Phoenix的配置，在HBase集群的每个服务器的hbase-site.xml配置文件中，加入：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;hbase<span class="selector-class">.regionserver</span><span class="selector-class">.wal</span><span class="selector-class">.codec</span>&lt;/name&gt;</div><div class="line">  &lt;value&gt;org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hbase</span><span class="selector-class">.regionserver</span><span class="selector-class">.wal</span><span class="selector-class">.IndexedWALEditCodec</span>&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>例如：在WXB_WORD表上对NAME字段建立DESC索引，该索引还包含了VALUE字段的值（注意，Phoenix是大小写不敏感的）。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">index</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> idx_wxb_word <span class="keyword">on</span> wxb_word (<span class="keyword">name</span> <span class="keyword">desc</span>) <span class="keyword">include</span> (<span class="keyword">value</span>) ;</div></pre></td></tr></table></figure></p>
<p>那么这种语句就查询得特别快：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">name</span>,<span class="keyword">value</span> <span class="keyword">from</span> wxb_word <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'AHNHLYPKGYAR_59999'</span>;</div></pre></td></tr></table></figure></p>
<p>但是如果查询语句中还需要知道其他字段的值，例如：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">name</span>,<span class="keyword">value</span>,userid <span class="keyword">from</span> wxb_word <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'AHNHLYPKGYAR_59999'</span>;</div></pre></td></tr></table></figure></p>
<p>那么，就和没有索引差不多，因为该索引中没有包含userid这个字段。<br>另外需要注意的是：主键不需要索引，查询也非常快，这是由HBASE的特性保证的。<br>删除索引语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">index</span> <span class="keyword">if</span> <span class="keyword">exists</span> idx_wxb_word <span class="keyword">on</span> wxb_word;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>使用Phoenix将SQL代码移植到HBase应注意以下几个问题。 </p>
<p>第一，应用场景是否合适？是否需要在单表中存储几乎无限的数据，并保证一定的查询性能？在数据量较少的情景下，Phoenix反而比Oracle的性能差。若要追求最高的性能，可以考虑同时使用关系数据库和HBase，并自己保证这部分数据的同步。 </p>
<p>第二，Phoenix、HBase、Hadoop、ZooKeeper的版本兼容问题。在大部分情况下，开发人员并不能决定HBase、Hadoop和ZooKeeper的版本，因此只能寻找合适的Phoenix版本来适配它们，这将导致你不能使用最新的Phoenix版本。如同本文中写的一样，这种情况会导致一些Phoenix SQL语句的特性得不到支持。 </p>
<p>第三，注意Phoenix的每个表必须包含一个主键（其实就是HBase的Primary rowkey），且该主键自带索引，合理设计这个主键能够带来性能上的提升和查询的便利。作为从SQL时代过来的程序员，抛弃节约空间的想法；在大数据时代，就是尽可能的用空间换时间。举个例子，你甚至可以将所有字段以一定的顺序和分隔符全部堆到主键上。 </p>
<p>第四，移植代码时，将所有SQL语句一一翻译为对应的Phoenix语句即可。注意参考Phoenix主页上的语法介绍，并一一进行测试。Phoenix对JDBC的支持很好，诸如连接池一类的特性可以原封不动的照搬。但若原来的程序使用了针对SQL语句的中间件之类的技术，请恕我也不知如何处理。<br>第五，一定要对Phoenix的表建立二级索引，索引中尽可能包含所有需要查询的字段。索引会导致数据插入速度变慢，但会带来巨大的性能提升。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://yangzsh.github.io/2017/01/19/使用Phoenix将SQL代码移植至HBase/" data-id="ciy3zox8700065gqz7iq7ivmu" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Phoenix/">Phoenix</a></div><div class="post-nav"><a href="/2017/01/09/Spark源码编译/" class="next">Spark源码编译</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://yangzsh.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/HBase二次索引/">HBase二次索引</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Scala/">Scala</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Spark源码编译/" style="font-size: 15px;">Spark源码编译</a> <a href="/tags/Scala语法/" style="font-size: 15px;">Scala语法</a> <a href="/tags/Phoenix/" style="font-size: 15px;">Phoenix</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/19/使用Phoenix将SQL代码移植至HBase/">使用Phoenix将SQL代码移植至HBase</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/09/Spark源码编译/">Spark源码编译</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/Scala基本语法和知识点/">Scala基本语法和知识点</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/memcached缓存安装配置/">memcached缓存安装配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>